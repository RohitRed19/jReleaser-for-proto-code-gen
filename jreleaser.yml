# JReleaser Configuration for grpc-services
# This configuration creates GitHub releases with Go-compatible tags (v{version})
# matching the Maven POM version.

# Project metadata - version is read from pom.xml automatically when using Maven plugin
project:
  name: grpc-services
  description: gRPC Services for Java and Go
  copyright: 2025 RohitRed19
  versionPattern: SEMVER
  snapshot:
    # Recognize Maven SNAPSHOT versions
    pattern: .*-SNAPSHOT
    # Use 'early-access' label for snapshot releases
    label: early-access

# GitHub release configuration
release:
  github:
    enabled: true
    host: github.com
    owner: RohitRed19
    name: jReleaser-for-proto-code-gen
    tagName: v{{projectVersion}}
    releaseName: Release v{{projectVersion}}
    # Allow overwriting existing releases
    overwrite: true
    # Also allow updating if overwrite fails
    update:
      enabled: true
      sections:
        - ASSETS
        - TITLE
        - BODY
    skipTag: false
    skipRelease: false
    branch: main
    connectTimeout: 20
    readTimeout: 60
    
    # Commit author for version commits
    commitAuthor:
      name: github-actions[bot]
      email: github-actions[bot]@users.noreply.github.com
    
    changelog:
      enabled: true
      formatted: ALWAYS
      preset: conventional-commits
      hide:
        categories:
          - merge
        contributors:
          - dependabot
          - renovate

hooks:
  command:
    # ============================================
    # SUCCESS: After release - Deploy + Go tags + Next SNAPSHOT
    # ============================================
    success:
      # Deploy to Nexus
      - active: RELEASE
        verbose: true
        filter:
          includes: [ 'release' ]
        cmd: >
          sh -c '
            echo "Deploying to Nexus..."
            mvn -B deploy -DskipTests -DskipRust=true -Denforcer.skip=true -s settings.xml
          '
      
      # Create Go module tags
      - active: RELEASE
        verbose: true
        filter:
          includes: [ 'release' ]
        cmd: >
          sh -c '
            echo "Generating Go module tags..."
            for mod in $(find . -name go.mod -not -path "*/target/*" -not -path "*/out/*"); do
              dir=$(dirname "$mod")
              dir=${dir#./}
              if [ "$dir" = "." ] || [ -z "$dir" ]; then
                tag="v{{projectVersion}}"
                continue
              else
                module=${dir%/v[0-9]*}
                tag="${module}/v{{projectVersion}}"
              fi
              echo "Creating tag: $tag"
              git tag -f "$tag"
              git push --no-progress -q origin "$tag"
            done
          '
      # Prepare for next development iteration
      - active: RELEASE
        verbose: true
        filter:
          includes: [ 'release' ]
        cmd: >
          sh -c '
            echo "Preparing next development iteration..."
            mvn -B versions:set -DnextSnapshot -DprocessAllModules
            mvn -B versions:commit
            git add -A
            git commit -m "[release] prepare for next development iteration"
            # Push quietly to avoid progress output on stderr being logged as errors
            git push --no-progress -q origin main
          '
